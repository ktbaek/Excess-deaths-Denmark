---
title: "Quarterly age and sex stratified death rates in Denmark from 2020 to 2022 (*work in progress*)"
author: "Kristoffer T. BÃ¦k"
output:
  rmarkdown::github_document:
    math_method: "webtex"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  dev = "png",
  dpi = 300,
  cache = FALSE
  )
library(tidyverse)
library(magrittr)
library(lubridate)
library(patchwork)
```

```{r style, include=FALSE}
# Typeface ----------------------------------------------------------------

quartzFonts(lato = c("Lato-Regular", "Lato-Bold", "Lato-Light", "Lato-BoldItalic"))

# Set gg themes ------------------------------------------------------------

theme_set(c19dk::theme_covid())

facet_theme <-
  theme(
    text = element_text(size = 7),
    plot.margin = margin(0.5, 0.5, 0.3, 0.5, "cm"),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 7),
    plot.title = element_text(size = 12, hjust = 0),
    plot.subtitle = element_text(hjust = 0),
    plot.caption = element_text(size = 10),
    strip.text = element_text(face = "bold"),
    axis.title.y = element_text(size = 8, margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.y.right = element_text(size = 8, margin = margin(t = 0, r = 0, b = 0, l = 20))
  )

colors_2 <- c("#E69F00", "#56B4E9")

colors_8 <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

colors_16 <- c(colorspace::lighten("#999999", 0.4), "#999999", 
            colorspace::lighten("#E69F00", 0.4), "#E69F00", 
            colorspace::lighten("#56B4E9", 0.4), "#56B4E9", 
            colorspace::lighten("#009E73", 0.4), "#009E73",
            colorspace::lighten("#F0E442", 0.6), "#F0E442",
            colorspace::lighten("#0072B2", 0.4), "#0072B2",
            colorspace::lighten("#D55E00", 0.4), "#D55E00", 
            colorspace::lighten("#CC79A7", 0.4), "#CC79A7")
```

## Summary

I calculated age and sex stratified death rates for each quarter during the Covid-19 pandemic in Denmark (2020 Q1 to, so far, 2022 Q3) and compared them to different baselines. The baselines were established by linear regression followed by adjustment for seasonality. Excess deaths were defined as deaths exceeding a prediction interval around the season adjusted baselines. This analysis therefore takes into account both long term trends, age composition, and seasonality. With this method, I find 81 and 62 excess deaths per 100,000 (~4800 and ~3700 excess deaths, respectively) from 2020 Q1 to 2022 Q3 using the 2010-2019 and 2015-2019 baseline, respectively. Finally, I explored how sensitive the result is to choice of baseline (using 2008-19, 2009-19, 2010-19, 2011-19, 2012-19, 2013-19, 2014-19, 2015-19, and 2016-19 as reference periods) and choice of data stratification (varying age bin size and sex stratification), testing 45 combinations in total. 

## Methods

### Data

Quarterly age-stratified [population data](https://www.statistikbanken.dk/FOLK1A) and daily age-stratified [death data](https://www.statistikbanken.dk/DODC1) were downloaded from [Danmarks Statistik](https://www.dst.dk/en/) on 23 Nov 2022. The daily death counts were summed by quarter for each stratification group. 

### Death rates

The death rate for a given population group in a given quarter is here defined as the number of deaths during the quarter divided by the population size at the start of the quarter.

### Baselines

Baselines were established in two steps. First, I used linear regression on quarterly death rates for a given reference period (e.g. 2010-2019) to establish linear baselines. Then, season adjusted baselines were calculated using the formulas below. Basically, I calculated the mean relative deviation ($\overline {rd_Q}$) from the linear baseline for each quarter-type, *Q* (1, 2, 3, or 4) for the reference years (*i*), and calculated the season adjusted baseline, $baseline_{s}$, as the linear baseline value plus the product of $\overline {rd_Q}$ and the linear baseline value. 

The 95% prediction interval *PI* was calculated as the season adjusted baseline value +/- 1.96 times the relative standard deviation for each quarter-type *Q* multiplied by the linear baseline value. 

$$\overline {rd_Q} = \frac{1}{N}\sum_{i=1}^{N} \frac{residual_{i,Q}}{baseline_{i,Q}}$$
$$baseline_{s \space i,Q} = baseline_{i,Q} + baseline_{i,Q} \times \overline {rd_Q} $$
$$PI_{i,Q} = baseline_{s \space i,Q} \pm baseline_{i,Q} \times 1.96 \times {SD_Q} $$

### Excess deaths

Excess death rates were defined as death rates exceeding the season adjusted baseline +/- the prediction interval.


### Main code

All data manipulations and calculations were performed in R.

```{r, main-functions, echo=TRUE}
# Main functions ---------------------------------------------------------------
make_base_df <- function(df, from, to, ...) {
  #' Helper function that makes nested data frame with death rates for the baseline period
  #' @param df Data frame with death rates
  #' @param from Baseline period start year
  #' @param to Baseline period end year
  #' @param ... Stratification variables
  #' @return Nested data frame
  df %>%
    select(..., Year, YQ, Quarter, Death_rate) %>%
    mutate(YQ = zoo::as.yearqtr(YQ)) %>% 
    filter(
      Year >= from,
      Year <= to
    ) %>%
    nest(base_data = -c(...))
}

calc_quart_stats <- function(df) {
  #' Helper function that calculates mean, SD, and prediction intervals 
  #' relative to baseline by quarter-type (1,2,3 or 4)
  #' @param df Data frame with death rates and fitted baseline for baseline period
  #' @return Data frame
  df %>%
    group_by(Quarter) %>%
    summarize(
      mean_Q = mean(.resid / .fitted),
      sd_Q = sd(.resid / .fitted),
      conf_lo_Q = mean_Q - 1.96 * sd_Q,
      conf_hi_Q = mean_Q + 1.96 * sd_Q
    )
}

calc_excess <- function(df1, df2) {
  #' Helper function that calculates season adjusted baselines, excess deaths 
  #' and excess death rates
  #' @param df1 Data frame with outputs from calc_quart_stats()
  #' @param df2 Data frame with death rates and fitted baseline for all years
  #' @return Data frame
  df2 %>%
    left_join(df1, by = c("Quarter")) %>%
    # use the relative mean deviation and sd calculated for each quarter type to
    # calculate quarter adjusted fit and prediction interval
    mutate(
      fit = .fitted + mean_Q * .fitted,
      sd = sd_Q * .fitted,
      conf_lo = .fitted + .fitted * conf_lo_Q,
      conf_hi = .fitted + .fitted * conf_hi_Q,
      z = (Death_rate - fit) / sd,
      # calculate excess death rate as death rates exceeding quarterly adjusted fit +/- pred interval
      excess_rate = case_when(
        Death_rate > conf_hi ~ Death_rate - conf_hi,
        Death_rate < conf_lo ~ Death_rate - conf_lo,
        TRUE ~ 0
      ),
      # calculate excess death rate as death rates exceeding either the
      # quarterly adjusted or the linear fit
      excess_rate_sab = Death_rate - fit,
      excess_rate_lb = Death_rate - .fitted,
      # calculate excess deaths as above, but multiplying the rates by population
      excess_abs = excess_rate * Population,
      excess_abs_sab = excess_rate_sab * Population,
      excess_abs_lb = excess_rate_lb * Population
    ) %>%
    select(fit, sd, conf_lo, conf_hi, z, excess_rate, excess_rate_sab, excess_rate_lb, 
           excess_abs, excess_abs_sab, excess_abs_lb)
}

make_prediction <- function(df, pred, from, to, ...) {
  #' Function that calculates baselines and excess deaths
  #' @param df Data frame with death rates
  #' @param pred String with name for the baseline
  #' @param from Baseline period start year
  #' @param to Baseline period end year
  #' @param ... Stratification variables
  #' @return Nested data frame
  df %>%
    select(..., Year, YQ, Quarter, Population, Death_rate) %>%
    mutate(prediction = pred, YQ = zoo::as.yearqtr(YQ)) %>%
    nest(all_data = -c(prediction, ...)) %>% # "all_data" is all data points from 2008-now
    full_join(make_base_df(df, from, to, ...), by = purrr::map_chr(enquos(...), rlang::as_label)) %>%
    mutate(
      # linear regression (= model)
      model = purrr::map(base_data, ~ lm(Death_rate ~ YQ, data = .x)),
      # fit and residuals on all data
      predict = purrr::map2(model, all_data, ~ broom::augment(.x, newdata = .y)),
      # fit and residuals on baseline data only
      predict_base = purrr::map2(model, base_data, ~ broom::augment(.x, newdata = .y)),
      # quarterly SDs and means
      qstats = purrr::map(predict_base, ~ calc_quart_stats(.x)),
      # season adjusted baselines, CI and excess deaths
      excess = purrr::map2(qstats, predict, ~ calc_excess(.x, .y))
    )
}
```

## Results

### Death rates and linear baselines


```{r make-10y-sex-preds}
# make age (10y bins) and sex stratified predictions using 2010-19 and 2015-19 as baselines
death_rates_10 <- read_csv("data/death_rates_10y_age_sex.csv") %>% 
  mutate(YQ = zoo::as.yearqtr(YQ))
  
preds <- make_prediction(death_rates_10, "2010-19", 2010, 2019, Age, Sex) %>%
  bind_rows(make_prediction(death_rates_10, "2015-19", 2015, 2019, Age, Sex))
```


I calculated death rates for each age and sex group using 10-year bins. The death rate is here defined as the number of deaths for a given quarter (Figure 1A and B) divided by the population size at the start of the quarter (Figure 1C). 

```{r Figure-1, echo=FALSE, fig.asp=1, layout="l-page", fig.cap = "**Population size and number of deaths in each age group for the each quarter from 2010 Q1 to 2022 Q3.** (A) Deaths shown with fixed y-axis, (B) deaths shown with variable y-axes, and (C) population size."}
p1 <- death_rates_10 %>%
  filter(Year >= 2010) %>% 
  ggplot() +
  geom_line(aes(YQ, Deaths, color = Sex), size = .25) +
  facet_grid(~Age) +
  zoo::scale_x_yearqtr(format = "%Y", n = 1) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_color_manual(name = "", values = colors_2) +
  labs(y = "Deaths") +
  facet_theme +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = rel(0.8)),
    panel.grid.minor.x = element_line(size = 0.1),
    strip.text = element_text(size = rel(0.7))
  )


p2 <- death_rates_10 %>%
  filter(Year >= 2010) %>% 
  ggplot() +
  geom_line(aes(YQ, Deaths, color = Sex), size = .25) +
  facet_wrap(~Age, scales = "free_y", ncol = 10) +
  zoo::scale_x_yearqtr(format = "%Y", n = 1) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_color_manual(name = "", values = colors_2) +
  labs(y = "Deaths") +
  facet_theme +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = rel(0.8)),
    panel.grid.minor.x = element_line(size = 0.1),
    strip.text = element_text(size = rel(0.7))
  )

p3 <- death_rates_10 %>%
  filter(Year >= 2010) %>% 
  ggplot() +
  geom_line(aes(YQ, Population, color = Sex), size = .25) +
  zoo::scale_x_yearqtr(format = "%Y", n = 1) +
  scale_y_continuous(labels = scales::number) +
  scale_color_manual(name = "", values = colors_2) +
  facet_grid(~Age, scales = "fixed") +
  facet_theme +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = rel(0.8)),
    panel.grid.minor.x = element_line(size = 0.1),
    strip.text = element_text(size = rel(0.7))
  )

p1 / p2 / p3 + plot_annotation(tag_levels = "A") + plot_layout(guides = "collect") & theme(legend.position = "bottom")
```

***Figure 1: Population size and number of deaths in each age group for the each quarter from 2010 Q1 to 2022 Q3.** (A) Deaths shown with fixed y-axis, (B) deaths shown with variable y-axes, and (C) population size.*

In order to calculate excess deaths-rates during the Covid-19 pandemic, a baseline defining the normal death rate must be established against which the death rates during 2020-22 is compared. I used two different reference periods to establish baselines, a 10-year period from 2010 to 2019 and 5-year period from 2015 to 2019. To establish baselines, I used linear regressions. 

Figure 2  shows the quarterly death rates for each group from 2010-2022 Q3. For most age groups, the 2010-19 baseline describes the death-rate trend very well. For the age group 70-79, however, it looks like the decreasing trend from 2010 to 2019 may be flattening towards the end of the period, highlighting the importance of baseline choice (as shown in Figure 10 the choice for this age group has a large impact). For  males in  age-groups 10-19 and 30-39, the two baselines differ greatly, which may be caused by a combination of large variation and outliers skewing the 2015-19 baselines. These groups, however, only contribute little to the overall excess death rate.


```{r Figure-2, echo=FALSE, fig.asp=1.3, layout="l-page", fig.cap = "**Death rates and baselines.** Quarterly death rates (deaths per 1000 people) for each age and sex group from 2010 to 2022 Q3 (colored lines). The black lines indicate linear regressions, defining two different baselines, based on the years 2010-19 (solid line) and 2015-19 (dashed line). The vertical gray line indicate the border between the reference period and the period of interest (2020-22)."}
preds %>%
  unnest(predict) %>%
  filter(
    Year >= 2010, 
    !(prediction == "2015-19" & Year < 2015)
    ) %>%
  ggplot() +
  geom_vline(xintercept = 2019.88, size = 0.4, color = "gray70") +
  geom_line(data = function(x) subset(x, prediction == "2010-19"), aes(YQ, Death_rate * 1000, color = Sex), size = .35) +
  geom_point(data = function(x) subset(x, prediction == "2010-19"), aes(YQ, Death_rate * 1000, color = Sex), stroke = 0, size = 1.1) +
  geom_line(aes(YQ, .fitted * 1000, group = interaction(Sex, prediction), linetype = prediction), size = .6) +
  zoo::scale_x_yearqtr(format = "%YQ%q", n = 5) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_linetype_discrete(labels = c("Baseline 2010-19", "Baseline 2015-19")) +
  scale_color_manual(values = colors_2) +
  labs(
    y = "Deaths per 1000"
  ) +
  facet_theme +
  facet_wrap(~Age, ncol = 2, scales = "free_y") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = rel(0.8)),
    panel.grid.minor.x = element_line(size = 0.1),
    legend.text = element_text(size = 8),
    panel.spacing = unit(0.3, "cm")
  )
```

***Figure 2: Death rates and linear baselines.** Quarterly death rates (deaths per 1000 people) for each age and sex group from 2010 to 2022 Q3 (colored lines). The black lines indicate linear regressions, defining two different baselines, based on the years 2010-19 (solid line) and 2015-19 (dashed line). The vertical gray line indicate the border between the reference period and the period of interest (2020-22).*


### Taking seasonality into account

Deaths in Denmark follow a seasonal pattern, which is primarily caused by seasonality in the death rates among the older age-groups (which contributes the majority of deaths in the total population), whereas deaths among the younger age groups do not exhibit significant seasonality (Figure 3). 

```{r Figure-3, echo=FALSE, fig.asp=0.6, layout="l-page", fig.cap = "**Seasonal deviation from linear baselines (using the 2010-19 reference period).** The colored lines show the relative (%) deviation from the linear baseline for each year from 2010-19. Black dots indicate the mean relative deviation for each quarter and vertical lines indicate the standard deviation of the relative deviations. The gray bands indicate the derived prediction intervals."}

preds %>%
  unnest(predict) %>%
  filter(
    prediction == "2010-19",
    Year >= 2010,
    Year <= 2019
  ) %>%
  left_join(unnest(preds, qstats), by = c("Age", "Sex", "Quarter", "prediction")) %>%
  ggplot() +
  geom_ribbon(aes(x = Quarter, ymin = conf_lo_Q * 100, ymax = conf_hi_Q * 100), fill = "gray70", alpha = 0.3) +
  geom_line(aes(Quarter, .resid / .fitted * 100, group = Year, color = Sex), size = 0.15) +
  geom_pointrange(aes(x = Quarter, y = mean_Q * 100, ymin = 100 * (mean_Q - sd_Q), ymax = 100 * (mean_Q + sd_Q)), size = 0.07) +
  
  scale_y_continuous(limits = c(NA, NA), labels = function(x) paste0(x, " %")) +
  labs(
    y = "Deviation from baseline (%)",
    x = "Quarter"
  ) +
  scale_color_manual(values = colors_2) +
  facet_theme +
  facet_grid(Sex ~ Age, scales = "fixed") +
  theme(
    axis.title.x = element_text(face = "bold", size = 8),
    panel.grid.minor.x = element_blank(),
    legend.text = element_text(size = 8),
    panel.spacing.y = unit(0.5, "cm"),
    legend.position = "none"
  )
```

***Figure 3: Seasonal deviation from linear baselines (showed for 2010-19 reference period).** The colored lines show the relative (%) deviation from the linear baseline for each year from 2010-19. Black dots indicate the mean relative deviation for each quarter and vertical lines indicate the standard deviation of the relative deviations. The gray bands indicate the derived prediction intervals.*

To better interpret how much the death rates during the pandemic deviate from the baselines, I established season adjusted baselines and a 95% prediction interval (calculated as 1.96 $\times$ standard deviation) based on the quarter-specific variation (shown for 2010-19 in Figure 3). The season adjusted baseline thus reflects the expected seasonal variation around the linear baseline, and the prediction interval reflects the expected variation around the season adjusted baseline, both based on the observed pre-pandemic variation in the reference period. Note, that I assume the expected variation to be proportional to the linear baseline value within each stratification group (the 40-49yo age group in Figure 6 exemplifies this). Figures 4 and 5 show the death rates for each age and sex group together with the season adjusted baselines.

```{r Figure-4, echo=FALSE, fig.asp=1.3, layout="l-page", fig.cap = "**Quarterly death rates and season adjusted baselines using  2010-19 as reference period.** Colored lines indicate the quarterly death rates, black lines indicate the season adjusted baselines, and the gray band indicate the 95% prediction interval. Sex is indicated on top, age on the right."}

gglayer_1 <- list(
  scale_y_continuous(limits = c(NA, NA)),
  zoo::scale_x_yearqtr(format = "%YQ%q", n = 5, expand = expansion(mult = c(0.025, .025))),
  labs(y = "Deaths per 1000"),
  scale_color_manual(guide = "none", values = colors_2),
  facet_theme,
  facet_grid(Age ~ Sex, scales = "free_y"),
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = rel(0.8)),
    panel.grid.minor.x = element_line(size = 0.1),
    legend.text = element_text(size = 8)
  )
)

preds %>%
  unnest(c(predict, excess)) %>%
  filter(prediction == "2010-19", Year >= 2010) %>%
  ggplot() +
  geom_ribbon(aes(YQ, ymin = conf_lo * 1000, ymax = conf_hi * 1000), fill = "gray70", alpha = 0.3) +
  geom_line(aes(YQ, fit * 1000), size = .3) +
  geom_vline(xintercept = 2019.88, size = 0.4, color = "gray70") +
  geom_line(aes(YQ, Death_rate * 1000, color = Sex), size = .5) +
  gglayer_1 +
  theme(panel.spacing.y = unit(0.7, "cm"))
```

***Figure 4: Quarterly death rates and season adjusted baselines using  2010-19 as reference period.** Colored lines indicate the quarterly death rates, black lines indicate the season adjusted baselines, and the gray band indicate the 95% prediction interval. Sex is indicated on top, age on the right.*


```{r Figure-5, echo=FALSE, fig.asp=1.3, layout="l-page", fig.cap = "**Quarterly death rates and season adjusted baselines using  2015-19 as reference period.** Colored lines indicate the quarterly death rates, black lines indicate the season adjusted baselines, and the gray band indicate the 95% prediction interval. Sex is indicated on top, age on the right."}

preds %>%
  unnest(c(predict, excess)) %>%
  filter(prediction == "2015-19", Year >= 2015) %>%
  ggplot() +
  geom_ribbon(aes(YQ, ymin = conf_lo * 1000, ymax = conf_hi * 1000), fill = "gray70", alpha = 0.3) +
  geom_line(aes(YQ, fit * 1000), size = .3) +
  geom_vline(xintercept = 2019.88, size = 0.4, color = "gray70") +
  geom_line(aes(YQ, Death_rate * 1000, color = Sex), size = .5) +
  gglayer_1 +
  theme(panel.spacing.y = unit(0.7, "cm"))
```

***Figure 5: Quarterly death rates and season adjusted baselines using  2015-19 as reference period.** Colored lines indicate the quarterly death rates, black lines indicate the season adjusted baselines, and the gray band indicate the 95% prediction interval. Sex is indicated on top, age on the right.*

In the following figures (Figure 6 and 7), I show the difference between the observed death rates and season adjusted baselines (called $\Delta$death rates), effectively de-trending and de-seasonalizing the death rates and baselines.

```{r Figure-6, echo=FALSE, fig.asp=1.3, layout="l-page", fig.cap = "**De-trended/de-seasonalized quarterly death rates and  baselines.** (A) Baseline reference period 2010-19, and (B) baseline reference period 2015-19. Colored lines indicate the quarterly death rates, black lines indicate the baselines, and the gray bands indicate the 95% prediction intervals. Sex is indicted on top, age on the right."}

p1 <- preds %>%
  unnest(c(predict, excess)) %>%
  filter(prediction == "2010-19", Year >= 2010) %>%
  ggplot() +
  geom_ribbon(aes(YQ, ymin = (conf_lo - fit) * 1000, ymax = (conf_hi - fit) * 1000), fill = "gray70", alpha = 0.35) +
  geom_line(aes(YQ, (fit  - fit) * 1000), size = .3) +
  geom_vline(xintercept = 2019.88, size = 0.4, color = "gray70") +
  geom_line(aes(YQ, (Death_rate - fit) * 1000, color = Sex), size = .4) +
  gglayer_1 +
  scale_y_continuous(limits = c(NA, NA)) +
  scale_color_manual(values = colors_2) +
  labs(y = expression(bold(Delta*"death rate (per 1000)"))) +
  theme(
    panel.spacing.y = unit(0.7, "cm"),
    plot.margin = margin(0.5, 0.2, 0.3, 0.5, "cm"))

p2 <- preds %>%
  unnest(c(predict, excess)) %>%
  filter(prediction == "2015-19", Year >= 2015) %>%
  ggplot() +
  geom_ribbon(aes(YQ, ymin = (conf_lo - fit) * 1000, ymax = (conf_hi - fit) * 1000), fill = "gray70", alpha = 0.35) +
  geom_line(aes(YQ, (fit  - fit) * 1000), size = .3) +
  geom_vline(xintercept = 2019.88, size = 0.4, color = "gray70") +
  geom_line(aes(YQ, (Death_rate - fit) * 1000, color = Sex), size = .4) +
  gglayer_1 +
  scale_y_continuous(limits = c(NA, NA)) +
  scale_color_manual(values = colors_2) +
  theme(
    panel.spacing.y = unit(0.7, "cm"), 
    axis.title.y = element_blank(),
    plot.margin = margin(0.5, 0.5, 0.3, 0.2, "cm"))

p1 + p2 + plot_annotation(tag_levels = "A") & theme(legend.position = "none")
```

***Figure 6: De-trended/de-seasonalized quarterly death rates and  baselines.** (A) Baseline reference period 2010-19, and (B) baseline reference period 2015-19. Colored lines indicate the quarterly death rates, black lines indicate the baselines, and the gray bands indicate the 95% prediction intervals. Sex is indicated on top, age on the right.*

```{r Figure-7, echo=FALSE, fig.asp=0.9, layout="l-page", fig.cap = "**De-trended/de-seasonalized quarterly death rates and  baselines for 2020-2022.** (A) Baseline reference period 2010-19, and (B) baseline reference period 2015-19. Colored lines indicate the quarterly death rates for males (blue lines) and females (red lines), black lines indicate the baselines, and the transparent colored bands indicate the 95% prediction intervals for males (blue) and females (red). Sex is indicted on top, age on the right."}

p1 <- preds %>%
  unnest(c(predict, excess)) %>%
  filter(prediction == "2010-19", Year >= 2020) %>%
  ggplot() +
  geom_ribbon(aes(YQ, ymin = (conf_lo - fit) * 1000, ymax = (conf_hi - fit) * 1000, fill = Sex), alpha = 0.15) +
  geom_line(aes(YQ, (fit  - fit) * 1000), size = .3) +
  geom_line(aes(YQ, (Death_rate - fit) * 1000, color = Sex), size = .7) +
  gglayer_1 +
  scale_y_continuous(limits = c(NA, NA)) +
  scale_color_manual(values = colors_2) +
  scale_fill_manual(guide = "none", values = colors_2) +
  facet_wrap(~ Age, ncol = 5, scales = "free_y") +
  labs(y = expression(bold(Delta*"death rate (per 1000)")))

p2 <- preds %>%
  unnest(c(predict, excess)) %>%
  filter(prediction == "2015-19", Year >= 2020) %>%
  ggplot() +
  geom_ribbon(aes(YQ, ymin = (conf_lo - fit) * 1000, ymax = (conf_hi - fit) * 1000, fill = Sex), alpha = 0.15) +
  geom_line(aes(YQ, (fit  - fit) * 1000), size = .3) +
  geom_line(aes(YQ, (Death_rate - fit) * 1000, color = Sex), size = .7) +
  gglayer_1 +
  scale_y_continuous(limits = c(NA, NA)) +
  scale_color_manual(values = colors_2) +
  scale_fill_manual(guide = "none", values = colors_2) +
  facet_wrap(~ Age, ncol = 5, scales = "free_y") +
  labs(y = expression(bold(Delta*"death rate (per 1000)"))) +
  theme(plot.margin = margin(0.3, 0.5, 0.3, 0.5, "cm"))

 p1 / p2 + plot_annotation(tag_levels = "A") + plot_layout(guides = "collect") & theme(legend.position = "bottom")
```

***Figure 7: De-trended/de-seasonalized quarterly death rates and  baselines for 2020-2022.** (A) Baseline reference period 2010-19, and (B) baseline reference period 2015-19. Colored lines indicate the quarterly death rates for males  and females, black lines indicate the baselines, and the transparent colored bands indicate the 95% prediction intervals for males (blue) and females (yellow).*


### Summarizing excess deaths

Here, I define excess deaths as deaths that exceed the season adjusted baseline +/- the prediction interval (thus excess deaths can be both a positive and negative number) for a given  group in a given quarter. It should be kept in mind that the excess death rates resulting from this method depends strongly on, among other things, how the prediction interval is defined. Excess deaths are back-calculated from the excess death rates using the age and sex stratified quarterly population numbers. 

Figure 8, 9 and Table 1 show quarterly excess deaths stratified on age and sex,  Figure 10 shows excess deaths for the whole period per age group, and Figure  11 shows excess deaths per 100,000 of the entire population per year.


```{r calc-pop-total}
pop_total <- preds %>%
  unnest(predict) %>%
  filter(prediction == "2010-19") %>%
  group_by(YQ) %>%
  summarize(Pop_total = sum(Population))
```

```{r Figure-8, echo=FALSE, fig.asp=0.6, layout="l-body-outset", fig.cap = "**Excess deaths by age and quarter.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction interval in a given quarter. Age groups 0-19 are ommitted."}

pred_names <- c(
  "2010-19" = "Baseline 2010-19",
  "2015-19" = "Baseline 2015-19"
)

preds %>%
  unnest(c(predict, excess)) %>%
  filter(Year >= 2020, !Age %in% c("0-9", "10-19")) %>%
  group_by(YQ, Age, prediction) %>% 
  summarize(excess_abs = sum(excess_abs)) %>% 
  ggplot() +
  geom_bar(stat = "identity", position = "stack", aes(YQ, excess_abs, fill = Age, color = Age), size = 0.1, width = 0.2) +
  scale_y_continuous(limits = c(NA, NA), labels = scales::number) +
  labs(
    y = "Excess deaths"
  ) +
  zoo::scale_x_yearqtr(format = "%Y Q%q", n = 9) +
  facet_wrap(~prediction, labeller = labeller(prediction = pred_names)) +
  scale_fill_manual(values = colors_8) +
  scale_color_manual(values = colors_8) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = rel(1.1)),
    axis.text.y = element_text(size = rel(1.1)),
    panel.grid.minor.x = element_blank(),
    legend.text = element_text(size = 8),
    legend.title = element_blank()
  )
```

***Figure 8: Excess deaths by age and quarter.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction interval in a given quarter. Age groups 0-19 are ommitted.*

```{r Figure-9, echo=FALSE, fig.asp=0.55, layout="l-body-outset", fig.cap = "**Excess deaths by sex and quarter.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction interval in a given quarter."}

preds %>%
  unnest(c(predict, excess)) %>%
  filter(Year >= 2020) %>%
  group_by(YQ, Sex, prediction) %>% 
  summarize(excess_abs = sum(excess_abs)) %>% 
  ggplot() +
  geom_bar(stat = "identity", position = "stack", aes(YQ, excess_abs, fill = Sex, color = Sex), size = 0.1, width = 0.2) +
  scale_y_continuous(limits = c(NA, NA), labels = scales::number) +
  scale_fill_manual(values = colors_2) +
  scale_color_manual(values = colors_2) +
  labs(
    y = "Excess deaths"
  ) +
  zoo::scale_x_yearqtr(format = "%Y Q%q", n = 9) +
  facet_wrap(~prediction, labeller = labeller(prediction = pred_names)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = rel(1.1)),
    axis.text.y = element_text(size = rel(1.1)),
    panel.grid.minor.x = element_blank(),
    legend.text = element_text(size = 8),
    legend.title = element_blank()
  )
```

***Figure 9: Excess deaths by sex and quarter.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction interval in a given quarter.*

```{r, excess-table, layout = "l-page"}
preds %>%
  unnest(c(predict, excess)) %>%
  filter(Year >= 2020) %>%
  group_by(Age, Sex, prediction) %>%
  summarize(excess_deaths = round(sum(excess_abs), 0)) %>%
  mutate(prediction = ifelse(prediction == "2010-19", "Base 2010-19", "Base 2015-19")) %>%
  pivot_wider(names_from = c(prediction, Sex), values_from = excess_deaths, names_sep = ": ") %>%
  select(Age, `Base 2010-19: Female`, `Base 2010-19: Male`, everything()) %>%
  ungroup() %>%
  add_row(Age = "All", summarise(., across(where(is.numeric), sum))) %>%
  knitr::kable(caption = "Table 1: Excess deaths for each age group, sex and baseline for the period 2020 Q1 - 2022 Q3. Rounded to whole numbers.")
```


```{r Figure-10, echo=FALSE, fig.asp=0.55, layout="l-body-outset", fig.cap = "**Excess deaths by sex and age.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction interval in a given quarter. Total excess deaths over the period 2020 Q1 - 2022 Q3 are summed. "}
preds %>%
  unnest(c(predict, excess)) %>%
  filter(Year >= 2020) %>%
  ggplot() +
  geom_bar(stat = "identity", aes(Age, excess_abs, fill = Sex, color = Sex), size = 0.1, width = 0.6) +
  scale_y_continuous(limits = c(NA, NA)) +
  scale_fill_manual(values = colors_2) +
  scale_color_manual(values = colors_2) +
  labs(
    y = "Excess deaths"
  ) +
  facet_wrap(~prediction, labeller = labeller(prediction = pred_names)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = rel(1.1)),
    axis.text.y = element_text(size = rel(1.1)),
    panel.grid.minor.x = element_blank(),
    legend.text = element_text(size = 8),
    legend.title = element_blank()
  )
```

***Figure 10: Excess deaths by sex and age.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction interval in a given quarter. Total excess deaths over the period 2020 Q1 - 2022 Q3 are summed.*

```{r Figure-11, echo=FALSE, fig.asp=0.5, fig.cap = "**Excess deaths per 100,000 of the total Danish population per year.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction interval for a given stratification in a given quarter. *) 2022 is calculated based on Q1, Q2, and Q3 only. The population for each year is taken as the mean of the population at the start of each quarter."}
preds %>%
  unnest(c(predict, excess)) %>%
  left_join(pop_total, by = "YQ") %>%
  filter(Year >= 2020) %>%
  group_by(Year, prediction) %>%
  summarize(
    excess_deaths = sum(excess_abs),
    Pop_total = mean(Pop_total, na.rm = TRUE)
  ) %>%
  mutate(Year = ifelse(Year == 2022, "2022*", as.character(Year))) %>%
  ggplot() +
  geom_bar(stat = "identity", position = "stack", aes(Year, excess_deaths / Pop_total * 100000), width = 0.9) +
  scale_y_continuous(limits = c(NA, NA), labels = scales::number) +
  scale_x_discrete(breaks = c("2020", "2021", "2022*")) +
  labs(
    y = "Excess deaths per 100,000"
  ) +
  facet_wrap(~prediction, labeller = labeller(prediction = pred_names)) +
  theme(
    axis.text.x = element_text(size = rel(1.1)),
    axis.text.y = element_text(size = rel(1.1)),
    strip.text.x = element_text(size = rel(1.1)),
    axis.title.y = element_text(size = rel(1.2)),
    panel.grid.minor.x = element_blank(),
    legend.text = element_text(size = 8)
  )
```

***Figure 11: Excess deaths per 100,000 of the total Danish population per year.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction interval for a given stratification in a given quarter. \*) 2022 is calculated based on Q1, Q2, and Q3 only. The population for each year is taken as the mean of the population at the start of each quarter.*

### Sensitivity to baseline

To explore the sensitivity to choice of baseline, I have calculated the total excess death rate using the above method for nine different baselines based on different reference periods (Figure 12).

```{r calc-more-baselines-10y-sex}
# make more predictions
preds_more <- 
  make_prediction(death_rates_10, "2008-19", 2008, 2019, Age, Sex) %>%
  bind_rows(make_prediction(death_rates_10, "2009-19", 2009, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_10, "2010-19", 2010, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_10, "2011-19", 2011, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_10, "2012-19", 2012, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_10, "2013-19", 2013, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_10, "2014-19", 2014, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_10, "2015-19", 2015, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_10, "2016-19", 2016, 2019, Age, Sex)) 
```

```{r Figure-12, echo=FALSE, layout = "l-body_outset", fig.asp=1.1, fig.cap = "**Excess deaths for the period 2020 Q1 - 2022 Q3 depending on baseline reference period.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction interval in a given quarter. Baseline period is indicated on the x-axis. (A) Excess deaths per 100,000 of the total Danish population, and (B) excess deaths stratified by age."}
p1 <- preds_more %>%
  unnest(c(predict, excess)) %>%
  left_join(pop_total, by = "YQ") %>%
  filter(Year >= 2020) %>%
  group_by(prediction) %>%
  summarize(
    excess_deaths = sum(excess_abs),
    Pop_total = mean(Pop_total, na.rm = TRUE)
  ) %>%
  ggplot() +
  geom_bar(stat = "identity", position = "stack", aes(prediction, excess_deaths / Pop_total * 100000), width = 0.9) +
  scale_y_continuous(limits = c(NA, NA), labels = scales::number) +
  labs(
    y = "Excess deaths per 100,000",
    x = "Baseline reference period"
  ) +
  theme(
    axis.text.x = element_text(size = rel(0.9)),
    axis.text.y = element_text(size = rel(1.1)),
    axis.title.x = element_text(face = "bold", size = rel(1)),
    panel.grid.minor.x = element_blank(),
    legend.text = element_text(size = 8)
  )

p2 <- preds_more %>%
  unnest(c(predict, excess)) %>%
  filter(Year >= 2020, !Age %in% c("0-9", "10-19")) %>%
  group_by(Age, prediction) %>%
  summarize(excess_deaths = sum(excess_abs)) %>%
  ggplot() +
  geom_bar(stat = "identity", position = "stack", aes(prediction, excess_deaths, fill = Age, color = Age), size = 0.1, width = 0.9) +
  scale_y_continuous(limits = c(NA, NA), labels = scales::number) +
  labs(
    y = "Excess deaths",
    x = "Baseline reference period"
  ) +
  scale_fill_manual(values = colors_8) +
  scale_color_manual(values = colors_8) +
  theme(
    axis.text.x = element_text(size = rel(0.9)),
    axis.text.y = element_text(size = rel(1.1)),
    axis.title.x = element_text(face = "bold", size = rel(1)),
    panel.grid.minor.x = element_blank(),
    legend.text = element_text(size = 8),
    legend.title = element_blank()
  )

 p1 / p2 + plot_annotation(tag_levels = "A")
```

***Figure 12: Excess deaths for the period 2020 Q1 - 2022 Q3 depending on baseline reference period.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction interval in a given quarter. Baseline period is indicated on the x-axis. (A) Excess deaths per 100,000 of the total Danish population, and (B) excess deaths stratified by age.*

As can be seen in Figure 12, the choice of reference period for the baseline has a considerable impact on the amount of  excess death. Most of the difference between baselines is driven by the 70-79 age group, except for the low rate of excess deaths found using the 2014-19 baseline -- a clear outlier -- which is mainly driven by the 80-89 age group. Figure 13 shows the de-trended and de-seasonalized baselines for these two age groups. The large effect of reference period on the 70-79 age group's excess deaths seems to stem from the long-term trend deviating from a linear fit, whereas the low excess deaths for the 80-89 age group using the 2014-19 baseline is due to a high mortality year (2013) followed by a low mortality year (2014).

```{r Figure-13, echo=FALSE, fig.asp=0.5, layout="l-screen", fig.cap = "**De-trended/de-seasonalized death rates and baselines for older age groups using different baseline reference periods.** Colored lines indicate the quarterly death rates for males (blue lines) and females (red lines), black lines indicate the baselines, and the transparent colored bands indicate the 95% prediction intervals for males (blue) and females (red), and the vertical gray line indicates the border between reference period and pandemic period. Age group is indicated on the right. "}


preds_more %>%
  unnest(c(predict, excess)) %>%
  filter(Age %in% c("70-79", "80-89")) %>% 
  mutate(
    base_start = as.numeric(str_sub(prediction, 1, 4)),
    fit = ifelse(Year < base_start, NA, fit),
    conf_lo = ifelse(Year < base_start, NA, conf_lo),
    conf_hi = ifelse(Year < base_start, NA, conf_hi)
    ) %>% 
  ggplot() +
  geom_line(aes(YQ, (fit  - fit) * 1000), size = .15) +
  geom_ribbon(aes(YQ, ymin = (conf_lo - fit) * 1000, ymax = (conf_hi - fit) * 1000, fill = Sex), alpha = 0.2) +
  geom_vline(xintercept = 2019.88, size = 0.2, color = "gray70") +
  geom_line(aes(YQ, excess_rate_sab * 1000, color = Sex), size = .25) +
  scale_y_continuous(limits = c(NA, NA)) +
  zoo::scale_x_yearqtr(format = "%YQ%q", n = 3) +
  labs(y = expression(bold(Delta*"death rate (per 1000)"))) +
  scale_color_manual(values = colors_2) +
  scale_fill_manual(guide = "none", values = colors_2) +
  facet_theme +
  facet_grid(Age ~ prediction, scales = "free_y") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = rel(0.7)),
    panel.grid.minor.x = element_line(size = 0.1),
    legend.text = element_text(size = 8),
    legend.title = element_blank()
  )
```

***Figure 13: De-trended/de-seasonalized death rates and baselines for older age groups using different baseline reference periods.** Colored lines indicate the quarterly death rates for males  and females , black lines indicate the baselines, and the transparent colored bands indicate the 95% prediction intervals for males (blue) and females (yellow), and the vertical gray line indicates the border between reference period and pandemic period. Age group is indicated on the right.*

### Sensitivity to stratification

To explore the sensitivity to the choice of stratification, I first used 5-year instead of 10-year age bins (Figure 14-16).



```{r calc-more-bases-5y-sex}
# make age and sex stratified predictions using 2010-19 and 2015-19 as baselines
death_rates_5 <- read_csv("data/death_rates_5y_age_sex.csv")

death_rates_5$Age <- factor(death_rates_5$Age, levels = c(
  "0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39",
  "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79",
  "80-84", "85-89", "90-94", "95+"
))

preds_5 <- 
  make_prediction(death_rates_5, "2008-19", 2008, 2019, Age, Sex) %>% 
  bind_rows(make_prediction(death_rates_5, "2009-19", 2009, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_5, "2010-19", 2010, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_5, "2011-19", 2011, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_5, "2012-19", 2012, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_5, "2013-19", 2013, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_5, "2014-19", 2014, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_5, "2015-19", 2015, 2019, Age, Sex)) %>%
  bind_rows(make_prediction(death_rates_5, "2016-19", 2016, 2019, Age, Sex))
```

```{r Figure-14, echo=FALSE, fig.asp=2.5, layout="l-page", fig.cap = "**De-trended/de-seasonalized quarterly death rates and  baselines using 5-year age brackets.** (A) Baseline reference period 2010-19, and (B) baseline reference period 2015-19. Colored lines indicate the quarterly death rates, black lines indicate the baselines, and the gray bands indicate the 95% prediction intervals. Sex is indicted on top, age on the right."}

p1 <- preds_5 %>%
  unnest(c(predict, excess)) %>%
  filter(prediction == "2010-19", Year >= 2010) %>%
  ggplot() +
  geom_ribbon(aes(YQ, ymin = (conf_lo - fit) * 1000, ymax = (conf_hi - fit) * 1000), fill = "gray70", alpha = 0.35) +
  geom_line(aes(YQ, (fit  - fit) * 1000), size = .3) +
  geom_vline(xintercept = 2019.88, size = 0.4, color = "gray70") +
  geom_line(aes(YQ, (Death_rate - fit) * 1000, color = Sex), size = .4) +
  gglayer_1 +
  scale_y_continuous(limits = c(NA, NA)) +
  scale_color_manual(values = colors_2) +
  labs(y = expression(bold(Delta*"death rate (per 1000)"))) +
  theme(
    panel.spacing.y = unit(0.7, "cm"),
    plot.margin = margin(0.5, 0.2, 0.3, 0.5, "cm"))

p2 <- preds_5 %>%
  unnest(c(predict, excess)) %>%
  filter(prediction == "2015-19", Year >= 2015) %>%
  ggplot() +
  geom_ribbon(aes(YQ, ymin = (conf_lo - fit) * 1000, ymax = (conf_hi - fit) * 1000), fill = "gray70", alpha = 0.35) +
  geom_line(aes(YQ, (fit  - fit) * 1000), size = .3) +
  geom_vline(xintercept = 2019.88, size = 0.4, color = "gray70") +
  geom_line(aes(YQ, (Death_rate - fit) * 1000, color = Sex), size = .4) +
  gglayer_1 +
  scale_y_continuous(limits = c(NA, NA)) +
  scale_color_manual(values = colors_2) +
  theme(
    panel.spacing.y = unit(0.7, "cm"), 
    axis.title.y = element_blank(),
    plot.margin = margin(0.5, 0.5, 0.3, 0.2, "cm"))

p1 + p2 + plot_annotation(tag_levels = "A") & theme(legend.position = "none")
```

***Figure 14: De-trended/de-seasonalized quarterly death rates and  baselines using 5-year age brackets.** (A) Baseline reference period 2010-19, and (B) baseline reference period 2015-19. Colored lines indicate the quarterly death rates, black lines indicate the baselines, and the gray bands indicate the 95% prediction intervals. Sex is indicted on top, age on the right.*


```{r Figure-15, echo=FALSE, fig.asp=1.3, layout="l-page", fig.cap = "**De-trended/de-seasonalized quarterly death rates and  baselines for 2020-2022 using 5-year age brackets.** (A) Baseline reference period 2010-19, and (B) baseline reference period 2015-19. Colored lines indicate the quarterly death rates for males (blue lines) and females (red lines), black lines indicate the baselines, and the transparent colored bands indicate the 95% prediction intervals for males (blue) and females (red). Sex is indicted on top, age on the right."}

p1 <- preds_5 %>%
  unnest(c(predict, excess)) %>%
  filter(prediction == "2010-19", Year >= 2020) %>%
  ggplot() +
  geom_ribbon(aes(YQ, ymin = (conf_lo - fit) * 1000, ymax = (conf_hi - fit) * 1000, fill = Sex), alpha = 0.15) +
  geom_line(aes(YQ, (fit  - fit) * 1000), size = .3) +
  geom_line(aes(YQ, (Death_rate - fit) * 1000, color = Sex), size = .7) +
  gglayer_1 +
  scale_y_continuous(limits = c(NA, NA)) +
  scale_color_manual(values = colors_2) +
  scale_fill_manual(guide = "none", values = colors_2) +
  facet_wrap(~ Age, ncol = 5, scales = "free_y") +
  labs(y = expression(bold(Delta*"death rate (per 1000)"))) 

p2 <- preds_5 %>%
  unnest(c(predict, excess)) %>%
  filter(prediction == "2015-19", Year >= 2020) %>%
  ggplot() +
  geom_ribbon(aes(YQ, ymin = (conf_lo - fit) * 1000, ymax = (conf_hi - fit) * 1000, fill = Sex), alpha = 0.15) +
  geom_line(aes(YQ, (fit  - fit) * 1000), size = .3) +
  geom_line(aes(YQ, (Death_rate - fit) * 1000, color = Sex), size = .7) +
  gglayer_1 +
  scale_y_continuous(limits = c(NA, NA)) +
  scale_color_manual(values = colors_2) +
  scale_fill_manual(guide = "none", values = colors_2) +
  facet_wrap(~ Age, ncol = 5, scales = "free_y") +
  labs(y = expression(bold(Delta*"death rate (per 1000)"))) +
  theme(plot.margin = margin(0.3, 0.5, 0.3, 0.5, "cm"))

 p1 / p2 + plot_annotation(tag_levels = "A") + plot_layout(guides = "collect") & theme(legend.position = "bottom")
```

***Figure 15: De-trended/de-seasonalized quarterly death rates and  baselines for 2020-2022 using 5-year age brackets.** (A) Baseline reference period 2010-19, and (B) baseline reference period 2015-19. Colored lines indicate the quarterly death rates for males  and females , black lines indicate the baselines, and the transparent colored bands indicate the 95% prediction intervals for males (blue) and females (red).*


```{r Figure-16}
preds_5 %>%
  unnest(c(predict, excess)) %>%
  filter(Year >= 2020, !Age %in% c("0-4", "5-9", "10-14", "15-19")) %>%
  group_by(Age, prediction) %>%
  summarize(excess_deaths = sum(excess_abs)) %>% 
  ggplot() +
  geom_bar(stat = "identity", position = "stack", aes(prediction, excess_deaths, fill = Age, color = Age), size = 0.1, width = 0.9) +
  scale_y_continuous(limits = c(NA, NA), labels = scales::number) +
  labs(
    y = "Excess deaths",
    x = "Baseline reference period"
  ) +
  scale_fill_manual(values = colors_16) +
  scale_color_manual(values = colors_16) +
  theme(
    axis.text.x = element_text(size = rel(0.9)),
    axis.text.y = element_text(size = rel(1.1)),
    axis.title.y = element_text(size = rel(1.2)),
    axis.title.x = element_text(face = "bold", size = rel(1)),
    panel.grid.minor.x = element_blank(),
    legend.text = element_text(size = 8),
    legend.title = element_blank()
  )

```

***Figure 16: Excess deaths by age for the period 2020 Q1 - 2022 Q3 depending on baseline reference period using 5-year brackets.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction interval in a given quarter. Baseline period is indicated on the x-axis.*

```{r calc-more-baselines-no-strata}
# make predictions on non-stratified data
death_rates_ns <- read_csv("data/death_rates_no_strata.csv")

preds_no_strata <- 
  make_prediction(death_rates_ns, "2008-19", 2008, 2019) %>%
  bind_rows(make_prediction(death_rates_ns, "2009-19", 2009, 2019)) %>%
  bind_rows(make_prediction(death_rates_ns, "2010-19", 2010, 2019)) %>%
  bind_rows(make_prediction(death_rates_ns, "2011-19", 2011, 2019)) %>%
  bind_rows(make_prediction(death_rates_ns, "2012-19", 2012, 2019)) %>%
  bind_rows(make_prediction(death_rates_ns, "2013-19", 2013, 2019)) %>%
  bind_rows(make_prediction(death_rates_ns, "2014-19", 2014, 2019)) %>%
  bind_rows(make_prediction(death_rates_ns, "2015-19", 2015, 2019)) %>%
  bind_rows(make_prediction(death_rates_ns, "2016-19", 2016, 2019)) 
```


```{r calc-more-bases-ages-no-sex}
# make age stratified predictions
death_rates_5a <- read_csv("data/death_rates_5y_age.csv")
death_rates_10a <- read_csv("data/death_rates_10y_age.csv")

preds_5_no_sex <- 
  make_prediction(death_rates_5a, "2008-19", 2008, 2019, Age) %>% 
  bind_rows(make_prediction(death_rates_5a, "2009-19", 2009, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_5a, "2010-19", 2010, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_5a, "2011-19", 2011, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_5a, "2012-19", 2012, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_5a, "2013-19", 2013, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_5a, "2014-19", 2014, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_5a, "2015-19", 2015, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_5a, "2016-19", 2016, 2019, Age))

preds_10_no_sex <- 
  make_prediction(death_rates_10a, "2008-19", 2008, 2019, Age) %>% 
  bind_rows(make_prediction(death_rates_10a, "2009-19", 2009, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_10a, "2010-19", 2010, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_10a, "2011-19", 2011, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_10a, "2012-19", 2012, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_10a, "2013-19", 2013, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_10a, "2014-19", 2014, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_10a, "2015-19", 2015, 2019, Age)) %>%
  bind_rows(make_prediction(death_rates_10a, "2016-19", 2016, 2019, Age))
```

```{r collect-all-predictions, echo=FALSE}
excess_whole_pop <- function(df,  ...) {
  # helper function
  df %>% 
   unnest(c(predict, excess)) %>%
  left_join(pop_total, by = "YQ") %>%
  filter(Year >= 2020) %>%
  group_by(..., prediction) %>%
  summarize(
    excess_abs = sum(excess_abs),
    excess_abs_sab = sum(excess_abs_sab),
    excess_abs_lb = sum(excess_abs_lb),
    Pop_total = mean(Pop_total, na.rm = TRUE)
  ) 
}

preds_strata_10 <- preds_more %>%
  excess_whole_pop() %>%  
  mutate(stratification = "Age (10y) & Sex")

preds_strata_5 <- preds_5 %>%
  excess_whole_pop() %>% 
  mutate(stratification = "Age (5y) & Sex")

preds_strata_10_ns <- preds_10_no_sex %>%
  excess_whole_pop() %>% 
  mutate(stratification = "Age (10y)")

preds_strata_5_ns <- preds_5_no_sex %>%
  excess_whole_pop() %>% 
  mutate(stratification = "Age (5y)")

all_preds <- preds_no_strata %>%
  excess_whole_pop() %>% 
  mutate(stratification = "Non-stratified") %>% 
  bind_rows(
    preds_strata_10,
    preds_strata_10_ns,
    preds_strata_5,
    preds_strata_5_ns
    )
```

```{r Figure-17, echo=FALSE,  layout = "l-body_outset", fig.asp=0.5, fig.cap = "**Excess deaths per 100,000 of the total Danish population for the period 2020 Q1 - 2022 Q3 for stratified and non-stratified data depending on baseline reference period.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction in a given quarter. Baseline reference period is indicated on the x-axis."}
all_preds %>% 
  ggplot() +
  geom_bar(stat = "identity", position = "dodge", aes(prediction, excess_abs / Pop_total * 100000, fill = stratification), width = 0.9) +
  scale_y_continuous(limits = c(NA, NA), labels = scales::number) +
  scale_fill_manual(values = colors_16) +
  labs(
    y = "Excess deaths per 100,000",
    x = "Baseline reference period"
  ) +
  theme(
    axis.text.x = element_text(size = rel(1)),
    axis.text.y = element_text(size = rel(1.1)),
    axis.title.y = element_text(size = rel(1.2)),
    axis.title.x = element_text(face = "bold", size = rel(1)),
    panel.grid.minor.x = element_blank(),
    legend.text = element_text(size = 10),
    legend.title = element_blank()
  )
```
***Figure 17: Excess deaths per 100,000 of the total Danish population for the period 2020 Q1 - 2022 Q3 for stratified and non-stratified data depending on baseline reference period.** Excess deaths are defined as deaths exceeding the season adjusted baseline +/- the 95% prediction in a given quarter. Baseline reference period is indicated on the x-axis.*

```{r Figure-18,  fig.asp=0.5,  echo=FALSE, layout="l-body_outset"}
all_preds %>%
  ggplot() +
  geom_bar(stat = "identity", position = "dodge", aes(prediction, excess_abs_sab / Pop_total * 100000, fill = stratification), width = 0.9) +
  scale_y_continuous(limits = c(NA, NA), labels = scales::number) +
  scale_fill_manual(values = colors_16) +
  labs(
    y = "Deaths over baseline mean per 100,000",
    x = "Baseline reference period"
  ) +
  theme(
    axis.text.x = element_text(size = rel(1)),
    axis.text.y = element_text(size = rel(1.1)),
    axis.title.x = element_text(face = "bold", size = rel(1)),
    panel.grid.minor.x = element_blank(),
    legend.text = element_text(size = 10),
    legend.title = element_blank()
  )
```

***Figure 18: Excess deaths\* per 100,000 of the total Danish population for the period 2020 Q1 - 2022 Q3 for stratified and non-stratified data depending on baseline reference period.** \*)Excess deaths in this plot are defined as the difference between  deaths and the season adjusted baseline. Baseline reference period is indicated on the x-axis.*

## Discussion and limitations

- Excess deaths by quarter (or shorter intervals) may underestimate excess deaths over longer time periods. For example if the death rates for a group are  above the baseline but within the prediction interval for the whole period of 2020-22, it will not count as excess death, but may still be unusual for a three-year period. One could instead compare deaths over a similar time span during the reference period.
- The sensitivity analysis is specific for this method and this dataset. Other methods or datasets may be more or less sensitive to baseline choice or stratification.
- ...